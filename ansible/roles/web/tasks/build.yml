---
- name: Creates CPDB directory for deployment
  become: yes
  become_user: root
  file: path=/CPDB state=directory owner={{ deploy_user }} group={{ deploy_group }}
  tags: setup

- name: Pull code from frontend repo
  git: repo=git@github.com:EastAgile/CPDBv2_mobile.git
    dest={{ application_root_path }}
    accept_hostkey=True
    version={{ branch }}
    key_file=/home/ansible/.ssh/khoi_github
  when: pull_code_from_git
  tags: deploy

- name : Install packages based on package.json.
  command: yarn install
    chdir={{ application_root_path }}
  tags: deploy

- name: Clean static root
  become: yes
  become_user: root
  file: path={{ nginx_dist_path }} state=absent
  tags: deploy

- name: Make sure `/var/www` is available
  file: path=/var/www state=directory owner={{ deploy_user }} group={{ deploy_group }}
  become: yes
  become_user: root
  tags: deploy

- name: Make sure logs directory is available
  file: path={{ application_logs_path }} state=directory owner={{ deploy_user }} group={{ deploy_group }} mode=0774
  tags: deploy

- name: Clean old nginx dist build
  file: path={{ nginx_dist_path }} state=absent
  tags: deploy

- name: Clean old build
  file: path={{ application_dist_path }}/dist state=absent
  tags: deploy

- name: Build everything
  command: yarn run dist
    chdir={{ application_root_path }}
  tags: deploy

- name: Move file to dist
  command: mv {{ application_dist_path }}/dist {{ nginx_dist_path }}
  tags: deploy
